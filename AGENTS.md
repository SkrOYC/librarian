# Agent Learnings

This document captures key learnings from agent sessions to help future work on this project.

## Nix Flake and bun2nix Configuration

### Building a Standalone Bun CLI Executable

This project uses Nix with bun2nix to build a **standalone native executable** (~4MB) instead of bundling the full Bun runtime (~126MB).

#### Build Commands

```bash
# Build the standalone executable (no node_modules needed)
nix build .#default

# Run directly from Nix
nix run .#default -- --help

# The binary will be at ./result/bin/librarian
./result/bin/librarian --help
```

#### Project Structure

**`flake.nix`**: Configures bun2nix overlay and exposes packages/apps:
- `packages.<system>.default` - the standalone executable
- `apps.<system>.default` - enables `nix run .#default`
- `devShells.<system>.default` - development shell with bun

**`default.nix`**: Uses `bun2nix.mkDerivation` with custom build phase:
```nix
{ stdenv, bun2nix, bun, ... }:

# Build a standalone Bun executable using bun2nix for reproducible dependencies
bun2nix.mkDerivation {
  pname = "librarian";
  version = "0.1.0";

  src = ./.;

  bunDeps = bun2nix.fetchBunDeps {
    bunNix = ./bun.nix;
  };

  # Override build phase to create standalone executable (4MB vs 126MB)
  buildPhase = ''
    bun build --outfile librarian --target bun ./src/cli.ts
  '';
}
```

**`bun.nix`**: Auto-generated by `bunx bun2nix -o bun.nix` - contains reproducible dependency fetches.

### Critical Agent Instructions

**DO NOT run `bun install` or `bun add`**: 
- All dependencies are managed by Nix via `bun.nix`
- Run `bunx bun2nix -o bun.nix` after any dependency changes to update the Nix configuration
- The Nix sandbox cannot access npm registry, so changes to `package.json` must be followed by bun2nix regeneration

**Development workflow**:
1. Edit `package.json` for dependency changes
2. Run `bunx bun2nix -o bun.nix` to regenerate `bun.nix`
3. Run `nix build .#default` to verify the build
4. Commit both `package.json` and `bun.nix` changes

**DO NOT commit `node_modules` or build artifacts**:
- `node_modules/` is already in `.gitignore`
- Build output goes to Nix store, not the project directory

### Documentation Links

- [Bun Executables (Standalone)](https://bun.com/docs/bundler/executables)
- [Bun2Nix Documentation](https://nix-community.github.io/bun2nix/)
- [Bun2Nix mkDerivation](https://nix-community.github.io/bun2nix/building-packages/mkDerivation.html)
